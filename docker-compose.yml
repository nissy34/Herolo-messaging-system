version: '3.7'

services: 
    app:
        image: nissy34/herolo:latest
        networks: 
            - backend
        environment: 
            SQLALCHEMY_DATABASE_URI: mysql://herolo:example@database.cdb1of9cn3bv.us-east-1.rds.amazonaws.com/herolo
            SECRET_KEY: "\\xbd\\x89lm\\xae{\\xbf\\x7f\\x93`\\x01\\xaf\\xd8\\xdf\\x81\\xfe\\t\\x80\\xc70\\xa7*\\xd1\\xff"

        deploy:
            mode: replicated
            update_config:
                parallelism: 1
                delay: 60s
            restart_policy:
                condition: any
                max_attempts: 5
            labels: 
                - "traefik.enable=true"
                - "traefik.docker.network=app_backend"
                ## HTTP Routers
                - "traefik.http.routers.app-rtr.entrypoints=https"
                - "traefik.http.routers.app-rtr.rule=Host(`herolo.duckdns.org`)"
                - "traefik.http.routers.app-rtr.tls=true"
 

                ## Middlewares
                - "traefik.http.routers.app-rtr.middlewares=middlewares-rate-limit@file"

                ## HTTP Services
                - "traefik.http.routers.app-rtr.service=app-svc"
                - "traefik.http.services.app-svc.loadbalancer.server.port=80"

    traefik:
        image: traefik:chevrotin 
        ports:
            - target: 80
              published: 80
              protocol: tcp
              mode: host
            - target: 443
              published: 443
              protocol: tcp
              mode: host
        networks: 
            - backend
        configs:
            - source: traefik_config
              target: /etc/traefik/traefik.yaml
            - source: traefik_rules
              target: /rules/rules.yaml
        secrets:
            - source: traefik_basicAuth
              target: /shared/.htpasswd
        volumes:
            - "traefik_data_cert:/letsEncrypt"
            - traefik_data_logs:/logs
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
        deploy:
            mode: replicated
            update_config:
                parallelism: 1
                delay: 60s
            restart_policy:
                condition: any
                max_attempts: 5
            labels: 

                - "traefik.enable=true"

                # HTTP-to-HTTPS Redirect
                - "traefik.http.routers.http-catchall.entrypoints=http"
                - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
                - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
                - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"


    
                # HTTP Routers
                - "traefik.http.routers.traefik-rtr.entrypoints=https"
                - "traefik.http.routers.traefik-rtr.rule=Host(`traefik.herolo.duckdns.org`)"
                - "traefik.http.routers.traefik-rtr.tls=true"

                - "traefik.http.routers.traefik-rtr.tls.certresolver=acmeResolver" # Comment out this line after first run of traefik to force the use of wildcard certs
                - "traefik.http.routers.traefik-rtr.tls.domains[0].main=herolo.duckdns.org"
                - "traefik.http.routers.traefik-rtr.tls.domains[0].sans=traefik.herolo.duckdns.org"
 

                ## Services - API
                - "traefik.http.routers.traefik-rtr.service=api@internal"
                - "traefik.http.services.dummy-svc.loadbalancer.server.port=9999"

                ## Middlewares
                - "traefik.http.routers.traefik-rtr.middlewares=middlewares-basic-auth@file,middlewares-rate-limit@file" 

configs:
    traefik_config:
        file: traefik/traefik.yaml
    traefik_rules:
        file: traefik/rules/rules.yaml
secrets:
    traefik_basicAuth:
        file: traefik/shared/.htpasswd
networks: 
    backend:
volumes: 
    traefik_data_cert:
    traefik_data_logs: